<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Курсы и группы</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tree {
            list-style: none;
            padding-left: 20px;
        }

        .course {
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            background: #e3e3e3;
            border-radius: 4px;
            margin: 5px 0;
        }

        .group {
            margin-left: 20px;
            padding: 5px;
            background: #d1e7fd;
            border-radius: 4px;
            margin: 3px 0;
        }

        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

            .form input, .form button {
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Справочник объектов - Курсы и группы</div>
        <div id="root"></div>
    </div>

    <script type="text/babel">
        function App() {
            const [courses, setCourses] = React.useState([]);
            const [expanded, setExpanded] = React.useState({});
            const [teachers, setTeachers] = React.useState([]);
            const [newCourse, setNewCourse] = React.useState({
                name: '',
                time: '',
                price: ''
            });

            // Загружаем курсы и преподавателей при монтировании компонента
            React.useEffect(() => {
                fetch('/api/courses-with-groups')
                    .then(response => response.json())
                    .then(data => setCourses(data));

                // Получаем список преподавателей
                fetch('/api/teachers')
                    .then(response => response.json())
                    .then(data => setTeachers(data));
            }, []);

            // Переключение состояния раскрытия курса
            const toggleExpand = (courseId) => {
                setExpanded(prev => ({ ...prev, [courseId]: !prev[courseId] }));
            };

            // Добавление группы
            const addGroup = (courseId) => {
                const name = document.getElementById(`groupName-${courseId}`).value;
                const teacherSelect = document.getElementById(`teacherId-${courseId}`);
                const teacher_id = teacherSelect.value;

                if (!name || !teacher_id) {
                    alert("Введите название группы и выберите преподавателя!");
                    return;
                }

                fetch('http://localhost:1337/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, teacher_id, course_id: courseId })
                }).then(response => response.json())
                  .then(data => {
                      alert(data.message);
                      location.reload();
                  });
            };

            // Добавление нового курса
            const handleAddCourse = () => {
                const { name, time, price } = newCourse;

                if (!name || !time || !price) {
                    alert("Заполните все поля курса!");
                    return;
                }

                fetch('http://localhost:1337/api/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, time, price })
                }).then(response => response.json())
                  .then(data => {
                      alert(data.message);
                      location.reload();
                  });
            };

            // Обработка изменения значений полей для нового курса
            const handleInputChange = (e) => {
                const { id, value } = e.target;
                setNewCourse(prev => ({
                    ...prev,
                    [id]: value
                }));
            };

            // Удаление курса
            const deleteCourse = (courseId) => {
                fetch(`http://localhost:1337/api/courses/${courseId}`, {
                    method: 'DELETE',
                }).then(response => response.json())
                  .then(data => {
                      alert(data.message);
                      setCourses(prev => prev.filter(course => course.course_id !== courseId)); // Обновляем список курсов
                  });
            };

            // Удаление группы
            const deleteGroup = (groupId) => {
                fetch(`http://localhost:1337/api/groups/${groupId}`, {
                    method: 'DELETE',
                }).then(response => response.json())
                  .then(data => {
                      alert(data.message);
                      setCourses(prev => prev.map(course => ({
                          ...course,
                          groups: course.groups.filter(group => group.group_id !== groupId)
                      }))); // Обновляем список групп
                  });
            };

            return (
                <div>
                    <h1>Добавить новый курс</h1>
                    <div className="form">
                        <input
                            id="name"
                            type="text"
                            placeholder="Название курса"
                            value={newCourse.name}
                            onChange={handleInputChange}
                        />
                        <input
                            id="time"
                            type="text"
                            placeholder="Время курса"
                            value={newCourse.time}
                            onChange={handleInputChange}
                        />
                        <input
                            id="price"
                            type="number"
                            placeholder="Цена курса"
                            value={newCourse.price}
                            onChange={handleInputChange}
                        />
                        <button onClick={handleAddCourse}>Добавить курс</button>
                    </div>

                    <ul className="tree">
                        {courses.map(course => (
                            <li key={course.course_id}>
                                <div className="course" onClick={() => toggleExpand(course.course_id)}>
                                    {expanded[course.course_id] ? '▼' : '▶'} {course.course_name} (Время: {course.course_time}, Цена: {course.course_price}₽)
                                </div>
                                <button onClick={() => deleteCourse(course.course_id)}>Удалить курс</button> {/* Кнопка для удаления */}
                                {expanded[course.course_id] && (
                                    <ul>
                                        {course.groups.map(group => (
                                            <li key={group.group_id} className="group">
                                                {group.group_name} (Преподаватель: {group.group_teacher_id})
                                                <button onClick={() => deleteGroup(group.group_id)}>Удалить группу</button> {/* Кнопка для удаления группы */}
                                            </li>
                                        ))}
                                        <li className="group">
                                            <input type="text" id={`groupName-${course.course_id}`} placeholder="Название группы" />
                                            <select id={`teacherId-${course.course_id}`}>
                                                <option value="">Выберите преподавателя</option>
                                                {teachers.map(teacher => (
                                                    <option key={teacher.teacher_id} value={teacher.teacher_id}>
                                                        {teacher.user_surname} {teacher.user_name} {teacher.user_patronymic}
                                                    </option>
                                                ))}
                                            </select>
                                            <button onClick={() => addGroup(course.course_id)}>Добавить группу</button>
                                        </li>
                                    </ul>
                                )}
                            </li>
                        ))}
                    </ul>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>